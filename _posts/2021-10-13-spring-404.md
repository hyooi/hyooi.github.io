---
layout: post
title:  "잘 기동되던 스프링 부트앱이 갑자기 404가 뜬다"
categories:
- 트러블슈팅
tags:
- spring
published: false
---

### 1. 개요
고통은 왜 몰아서 오는것일까.

간만에 웹어드민 애플리케이션에 CD파이프라인을 적용했더니 일부api가 404가 발생했다.

<br/>

### 2. 로그를 분석하자
AbstractHandlerMethodMapping

#### 2.1. 정상 기동 시 로그
```
[DEBUG][2021-10-12 15:26:15,252] AbstractHandlerMethodMapping.java:363(main) - 98 mappings in 'requestMappingHandlerMapping'

[DEBUG][2021-10-13 12:33:05,709] AbstractHandlerMethodMapping.java:363(main) - 567 mappings in 'requestMappingHandlerMapping'
```

```
[DEBUG][2021-10-12 15:26:14,280] DefaultSingletonBeanRegistry.java:225(main) - Creating shared instance of singleton bean 'menuController'
[TRACE][2021-10-12 15:26:14,280] AbstractAutowireCapableBeanFactory.java:489(main) - Creating instance of bean 'menuController'
[TRACE][2021-10-12 15:26:14,280] AbstractAutowireCapableBeanFactory.java:592(main) - Eagerly caching bean 'menuController' to allow for resolving potential circular references
[TRACE][2021-10-12 15:26:14,280] AbstractBeanFactory.java:264(main) - Returning cached instance of singleton bean 'menuService'
[TRACE][2021-10-12 15:26:14,280] AutowiredAnnotationBeanPostProcessor.java:586(main) - Autowiring by type from bean name 'menuController' to bean named 'menuService'
[DEBUG][2021-10-12 15:26:14,281] DelegatingMethodSecurityMetadataSource.java:76(main) - Caching method [CacheKey[kello.web.controller.MenuController; public java.util.List kello.web.controller.MenuController.getAllList()]] with attributes [MenuSecurityConfig(menus=[MNU01608], readonly=true)]
[TRACE][2021-10-12 15:26:14,281] AbstractAutoProxyCreator.java:539(main) - Creating implicit proxy for bean 'menuController' with 0 common interceptors and 1 specific interceptors
[TRACE][2021-10-12 15:26:14,281] CglibAopProxy.java:162(main) - Creating CGLIB proxy: SingletonTargetSource for target object [kello.web.controller.MenuController@1478ffd7]
[TRACE][2021-10-12 15:26:14,281] CglibAopProxy.java:897(main) - Unable to apply any optimizations to advised method: public java.util.List kello.web.controller.MenuController.getAllList()
[DEBUG][2021-10-12 15:26:14,281] DelegatingMethodSecurityMetadataSource.java:76(main) - Caching method [CacheKey[kello.web.controller.MenuController; public kello.web.domain.Menu kello.web.controller.MenuController.getMenuDetail(kello.web.domain.Menu)]] with attributes [MenuSecurityConfig(menus=[MNU01608], readonly=true)]
[TRACE][2021-10-12 15:26:14,281] CglibAopProxy.java:897(main) - Unable to apply any optimizations to advised method: public kello.web.domain.Menu kello.web.controller.MenuController.getMenuDetail(kello.web.domain.Menu)
[DEBUG][2021-10-12 15:26:14,281] DelegatingMethodSecurityMetadataSource.java:76(main) - Caching method [CacheKey[kello.web.controller.MenuController; public int kello.web.controller.MenuController.update(kello.web.jpa.entity.KelloMenu)]] with attributes [MenuSecurityConfig(menus=[MNU01608], readonly=false)]
[TRACE][2021-10-12 15:26:14,282] CglibAopProxy.java:897(main) - Unable to apply any optimizations to advised method: public int kello.web.controller.MenuController.update(kello.web.jpa.entity.KelloMenu)
[TRACE][2021-10-12 15:26:14,285] ScheduledAnnotationBeanPostProcessor.java:368(main) - No @Scheduled annotations found on bean class: class kello.web.controller.MenuController
[TRACE][2021-10-12 15:26:14,285] AbstractAutowireCapableBeanFactory.java:526(main) - Finished creating instance of bean 'menuController'
[TRACE][2021-10-12 15:26:15,246] AbstractHandlerMethodMapping.java:291(main) - 
	b.w.c.MenuController:
	{POST [/api/menu/getAll]}: getAllList()
	{POST [/api/menu/getdetail]}: getMenuDetail(Menu)
	{POST [/api/menu/update]}: update(KelloMenu)
```
#### 2.2. 비정상 기동 시 로그
```
[DEBUG][2021-10-12 15:26:13,311] DefaultSingletonBeanRegistry.java:225(main) - Creating shared instance of singleton bean 'flowController'
[TRACE][2021-10-12 15:26:13,311] AbstractAutowireCapableBeanFactory.java:489(main) - Creating instance of bean 'flowController'
[TRACE][2021-10-12 15:26:13,312] AbstractAutowireCapableBeanFactory.java:592(main) - Eagerly caching bean 'flowController' to allow for resolving potential circular references
[TRACE][2021-10-12 15:26:13,312] AbstractBeanFactory.java:264(main) - Returning cached instance of singleton bean 'flowService'
[TRACE][2021-10-12 15:26:13,312] AutowiredAnnotationBeanPostProcessor.java:586(main) - Autowiring by type from bean name 'flowController' to bean named 'flowService'
[TRACE][2021-10-12 15:26:13,313] CglibAopProxy.java:162(main) - Creating CGLIB proxy: SingletonTargetSource for target object [kello.web.controller.FlowController@3e929c9c]
[TRACE][2021-10-12 15:26:13,314] CglibAopProxy.java:897(main) - Unable to apply any optimizations to advised method: public int kello.web.controller.FlowController.deploy(kello.web.domain.ui.FlowInformationDetail)
[TRACE][2021-10-12 15:26:13,314] CglibAopProxy.java:897(main) - Unable to apply any optimizations to advised method: public kello.web.domain.ui.FlowInformationDetail kello.web.controller.FlowController.getNoRegistList(kello.web.domain.ui.FlowInformationListIn)
[TRACE][2021-10-12 15:26:13,314] CglibAopProxy.java:897(main) - Unable to apply any optimizations to advised method: public kello.web.domain.ui.FlowInformationDetail kello.web.controller.FlowController.getDtlList(kello.web.domain.table.FlowInfoDtlDto)
[TRACE][2021-10-12 15:26:13,314] CglibAopProxy.java:897(main) - Unable to apply any optimizations to advised method: public org.springframework.web.servlet.ModelAndView kello.web.controller.FlowController.getFlowListExcel(kello.web.domain.ui.FlowInformationListIn)
[TRACE][2021-10-12 15:26:13,314] CglibAopProxy.java:897(main) - Unable to apply any optimizations to advised method: public kello.web.domain.ui.UiOutList kello.web.controller.FlowController.getList(com.querydsl.core.types.Predicate,org.springframework.data.domain.Pageable)
[TRACE][2021-10-12 15:26:13,314] CglibAopProxy.java:897(main) - Unable to apply any optimizations to advised method: public int kello.web.controller.FlowController.add(kello.web.jpa.entity.KelloFlow)
[TRACE][2021-10-12 15:26:13,314] CglibAopProxy.java:897(main) - Unable to apply any optimizations to advised method: public int kello.web.controller.FlowController.update(kello.web.jpa.entity.KelloFlow)
[TRACE][2021-10-12 15:26:13,314] CglibAopProxy.java:897(main) - Unable to apply any optimizations to advised method: public int kello.web.controller.FlowController.delete(kello.web.jpa.entity.KelloFlow)
[DEBUG][2021-10-12 15:26:13,319] DelegatingMethodSecurityMetadataSource.java:76(main) - Caching method [CacheKey[kello.web.controller.FlowController$$EnhancerBySpringCGLIB$$a448a1f5; public int kello.web.controller.FlowController.deploy(kello.web.domain.ui.FlowInformationDetail)]] with attributes [MenuSecurityConfig(menus=[MNU00502], readonly=false)]
[TRACE][2021-10-12 15:26:13,319] AbstractAutoProxyCreator.java:539(main) - Creating implicit proxy for bean 'flowController' with 0 common interceptors and 1 specific interceptors
[TRACE][2021-10-12 15:26:13,319] JdkDynamicAopProxy.java:124(main) - Creating JDK dynamic proxy: SingletonTargetSource for target object [kello.web.controller.FlowController$$EnhancerBySpringCGLIB$$a448a1f5@597edc92]
[TRACE][2021-10-12 15:26:13,320] ScheduledAnnotationBeanPostProcessor.java:368(main) - No @Scheduled annotations found on bean class: class kello.web.controller.FlowController
[TRACE][2021-10-12 15:26:13,320] AbstractAutowireCapableBeanFactory.java:526(main) - Finished creating instance of bean 'flowController'

```

<br/>

### 3. CGLIB? JDK proxy?
#### 3.1. aop
AOP(Aspect-Oriented Programming)는 프로그램 구조에 대한 또 다른 사고 방식을 제공하여 객체 지향 프로그래밍(OOP)을 보완합니다. OOP에서 모듈화의 핵심 단위는 클래스인 반면, AOP에서 모듈화의 단위는 측면입니다. Aspect는 여러 유형과 객체를 가로지르는 문제(트랜잭션 관리 등)의 모듈화를 가능하게 합니다. (이러한 문제는 종종 AOP 문헌에서 "교차" 문제라고 합니다.)

#### 3.2. cglib
Spring AOP는 기본적으로 AOP 프록시에 표준 JDK 동적 프록시를 사용합니다. 이를 통해 모든 인터페이스(또는 인터페이스 집합)를 프록시할 수 있습니다.

Spring AOP는 CGLIB 프록시도 사용할 수 있습니다. 이것은 인터페이스가 아닌 프록시 클래스에 필요합니다. 기본적으로 비즈니스 오브젝트가 인터페이스를 구현하지 않는 경우 CGLIB가 사용됩니다. 클래스보다는 인터페이스에 프로그래밍하는 것이 좋은 방법이므로 비즈니스 클래스는 일반적으로 하나 이상의 비즈니스 인터페이스를 구현합니다. 인터페이스에 선언되지 않은 메서드를 조언해야 하거나 프록시된 개체를 구체적인 유형으로 메서드에 전달해야 하는 경우(희망하는 경우) CGLIB 사용 을 강제할 수 있습니다 .

Spring AOP가 프록시 기반이라는 사실을 파악하는 것이 중요합니다. 이 구현 세부 사항이 실제로 의미하는 바에 대한 철저한 조사는 AOP 프록시 이해를 참조하십시오 .

URL 맵핑을 진행하는 AbstractHandlerMethodMapping 인스턴스에서 JDK 프록시가 적용된 컨트롤러는 URL 맵핑을 하지 못합니다. 결국 해당 컨트롤러에 포함된 메서드로의 HTTP Request에 대해 톰캣이 404를 노출하게 됩니다.

<br/>

### 4. 해결!

```xml
<aop:config proxy-target-class="true" />

<aop:aspectj-autoproxy proxy-target-class="true"/>
```

controller클래스에 해당 어노테이션 추가
```java
@Scope( proxyMode = ScopedProxyMode.TARGET_CLASS )

```
<br/>

### 4. 결론
